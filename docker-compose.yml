version: "3.8"

networks:
  haystack-net:
    driver: bridge

volumes:
  data-volume:
    driver: local
  rabbitmq-data:
    driver: local

services:
  # --- 1. API Gateway ---
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    image: haystack-api:latest
    ports:
      - "8000:8000"
    environment:
      DISCOVERY_SERVICE_URL: http://discovery:8501
      CACHE_URL: http://cache:8201
      # Point to Similarity Master on internal port 8000
      SIMILARITY_URL: http://similarity:8000
      USE_RABBITMQ: "1"
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
      STORE_PORTS: "store1=store1:8101,store2=store2:8101,store3=store3:8101"
    networks:
      - haystack-net
    depends_on:
      - discovery
      - directory_primary
      - directory_replica
      - store1
      - store2
      - store3
      - cache
      - similarity
      - rabbitmq
    command: ["uvicorn", "services.api.main:app", "--host", "0.0.0.0", "--port", "8000"]

  # --- 2. Service Discovery ---
  discovery:
    build:
      context: .
      dockerfile: services/discovery/Dockerfile
    image: haystack-discovery:latest
    environment:
      DISCOVERY_FILE: data/discovery.json
    ports:
      - "8501:8501"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    command: ["uvicorn", "services.discovery.main:app", "--host", "0.0.0.0", "--port", "8501"]

  # --- 3. Directory Services ---
  directory_primary:
    build:
      context: .
      dockerfile: services/directory/Dockerfile
    image: haystack-directory:latest
    environment:
      DIRECTORY_MODE: primary
      DISCOVERY_SERVICE_URL: http://discovery:8501
      DB_PATH: data/directory.db
      AVAILABLE_STORES: "store1,store2,store3"
      HOSTNAME: directory_primary
      LV_CAPACITY_BYTES: 1000000000
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
    ports:
      - "8001:8001"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    depends_on:
      - discovery
      - rabbitmq
    command: ["uvicorn", "services.directory.main:app", "--host", "0.0.0.0", "--port", "8001"]

  directory_replica:
    build:
      context: .
      dockerfile: services/directory/Dockerfile
    image: haystack-directory:latest
    environment:
      DIRECTORY_MODE: replica
      DISCOVERY_SERVICE_URL: http://discovery:8501
      DB_PATH: data/directory.db
      AVAILABLE_STORES: "store1,store2,store3"
      HOSTNAME: directory_replica
      LV_CAPACITY_BYTES: 1000000000
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    depends_on:
      - discovery
      - rabbitmq
    command: ["uvicorn", "services.directory.main:app", "--host", "0.0.0.0", "--port", "8001"]

  # --- 4. Store Services ---
  store1:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store1
      DATA_DIR: /app/data/store1_data
    ports:
      - "8101:8101"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store1_data
    command: ["uvicorn", "services.store.main:app", "--host", "0.0.0.0", "--port", "8101"]

  store2:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store2
      DATA_DIR: /app/data/store2_data
    ports:
      - "8102:8101"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store2_data
    command: ["uvicorn", "services.store.main:app", "--host", "0.0.0.0", "--port", "8101"]

  store3:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store3
      DATA_DIR: /app/data/store3_data
    ports:
      - "8103:8101"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store3_data
    command: ["uvicorn", "services.store.main:app", "--host", "0.0.0.0", "--port", "8101"]

  # --- 5. Scalable Similarity Services ---
  
  # MASTER: Serves search requests
  similarity:
    build:
      context: .
      dockerfile: services/similarity/Dockerfile
    image: haystack-similarity-master:latest
    ports:
      - "8301:8000"
    environment:
      - SERVICE_MODE=MASTER
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - KMP_DUPLICATE_LIB_OK=TRUE
      - OMP_NUM_THREADS=1
      # DATA_DIR must match the volume mapping below
      - DATA_DIR=/data
    networks:
      - haystack-net
    volumes:
      # CRITICAL FIX: Map to /data so both services see the same files
      - data-volume:/data
    depends_on:
      - rabbitmq

  # WORKER: Processes uploads from RabbitMQ
  similarity-worker:
    build:
      context: .
      dockerfile: services/similarity/Dockerfile
    image: haystack-similarity-worker:latest
    environment:
      - SERVICE_MODE=WORKER
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - API_URL=http://api:8000
      - KMP_DUPLICATE_LIB_OK=TRUE
      - OMP_NUM_THREADS=1
      - DATA_DIR=/data
    deploy:
      replicas: 2
    networks:
      - haystack-net
    volumes:
      # CRITICAL FIX: Map to /data
      - data-volume:/data
    depends_on:
      - rabbitmq
      - api

  # --- 6. Cache Service ---
  cache:
    build:
      context: .
      dockerfile: services/cache/Dockerfile
    image: haystack-cache:latest
    environment:
      CACHE_DATA_DIR: /app/data/cache_data
      MAX_CACHE_SIZE_BYTES: 50000000
    ports:
      - "8201:8201"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    command: ["uvicorn", "services.cache.main:app", "--host", "0.0.0.0", "--port", "8201"]

  # --- 7. RabbitMQ Service ---
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - haystack-net