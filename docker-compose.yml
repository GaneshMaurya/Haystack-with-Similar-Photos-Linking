version: "3.8"

# Define a shared network for service communication
networks:
  haystack-net:
    driver: bridge

# Define volumes for persistent data
volumes:
  data-volume:
    driver: local
  rabbitmq-data:
    driver: local

services:
  # ----------------------------------------------------
  # 1. API Gateway (Entry Point) - MODIFIED
  # ----------------------------------------------------
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    image: haystack-api:latest
    ports:
      - "8000:8000"
    environment:
      DISCOVERY_SERVICE_URL: http://discovery:8501
      CACHE_URL: http://cache:8201
      # MODIFIED: Point to the new similarity master service on its internal port
      SIMILARITY_URL: http://similarity-master:8000
      # MODIFIED: Enable RabbitMQ for event-driven indexing
      USE_RABBITMQ: "1"
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
      STORE_PORTS: "store1=store1:8101,store2=store2:8101,store3=store3:8101"
    networks:
      - haystack-net
    depends_on:
      - discovery
      - directory_primary
      - store1
      - store2
      - store3
      - cache
      - rabbitmq
      # MODIFIED: Depends on the new master, not the old service
      - similarity-master
    command:
      [
        "uvicorn",
        "services.api.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
      ]

  # ----------------------------------------------------
  # 2. Service Discovery
  # ----------------------------------------------------
  discovery:
    build:
      context: .
      dockerfile: services/discovery/Dockerfile
    image: haystack-discovery:latest
    environment:
      DISCOVERY_FILE: data/discovery.json
    ports:
      - "8501:8501"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    command:
      [
        "uvicorn",
        "services.discovery.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8501",
      ]

  # ----------------------------------------------------
  # 3. Directory Services (Primary & Replica)
  # ----------------------------------------------------
  directory_primary:
    build:
      context: .
      dockerfile: services/directory/Dockerfile
    image: haystack-directory:latest
    environment:
      DIRECTORY_MODE: primary
      DISCOVERY_SERVICE_URL: http://discovery:8501
      DB_PATH: data/directory.db
      AVAILABLE_STORES: "store1,store2,store3"
      HOSTNAME: directory_primary
      LV_CAPACITY_BYTES: 1000000000
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
    ports:
      - "8001:8001"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    depends_on:
      - discovery
      - rabbitmq
    command:
      [
        "uvicorn",
        "services.directory.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8001",
      ]

  directory_replica:
    build:
      context: .
      dockerfile: services/directory/Dockerfile
    image: haystack-directory:latest
    environment:
      DIRECTORY_MODE: replica
      DISCOVERY_SERVICE_URL: http://discovery:8501
      DB_PATH: data/directory.db
      AVAILABLE_STORES: "store1,store2,store3"
      HOSTNAME: directory_replica
      LV_CAPACITY_BYTES: 1000000000
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    depends_on:
      - discovery
      - rabbitmq
    command:
      [
        "uvicorn",
        "services.directory.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8001",
      ]

  # ----------------------------------------------------
  # 4. Store Services
  # ----------------------------------------------------
  store1:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store1
      DATA_DIR: /app/data/store1_data
    ports:
      - "8101:8101"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store1_data
    command:
      [
        "uvicorn",
        "services.store.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8101",
      ]

  store2:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store2
      DATA_DIR: /app/data/store2_data
    ports:
      - "8102:8101"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store2_data
    command:
      [
        "uvicorn",
        "services.store.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8101",
      ]

  store3:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store3
      DATA_DIR: /app/data/store3_data
    ports:
      - "8103:8101"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store3_data
    command:
      [
        "uvicorn",
        "services.store.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8101",
      ]

  # ----------------------------------------------------
  # 5. Similarity Service - REMOVED OLD SERVICE
  # ----------------------------------------------------

  # ----------------------------------------------------
  # 5. NEW Similarity Service (Master)
  # ----------------------------------------------------
  similarity-master:
    build:
      context: .
      # NEW: Point to the new similarity service Dockerfile
      dockerfile: services/similarity-service/Dockerfile
    image: haystack-similarity-service:latest
    environment:
      - SERVICE_MODE=MASTER
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - API_GATEWAY_URL=http://api:8000
      - DATA_BASE_DIR=/app/data
    ports:
      # Expose the master's API on host port 8301 for consistency
      - "8301:8000"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data # Master needs persistent storage for the FAISS index
    depends_on:
      - rabbitmq
    command: ["python", "main.py"]

  # ----------------------------------------------------
  # 5. NEW Similarity Service (Worker)
  # ----------------------------------------------------
  similarity-worker:
    build:
      context: .
      dockerfile: services/similarity-service/Dockerfile
    image: haystack-similarity-service:latest
    # NEW: Easily scale workers using the deploy key
    deploy:
      replicas: 2
    environment:
      - SERVICE_MODE=WORKER
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - API_GATEWAY_URL=http://api:8000
      - DISCOVERY_SERVICE_URL=http://discovery:8501
      - STORE_PORTS=store1=store1:8101,store2=store2:8101,store3=store3:8101
    networks:
      - haystack-net
    volumes:
      # Volume can be used for caching models
      - data-volume:/app/data
    depends_on:
      - rabbitmq
      - discovery
      - directory_primary
      - store1
      - store2
      - store3
    command: ["python", "main.py"]

  # ----------------------------------------------------
  # 6. Cache Service
  # ----------------------------------------------------
  cache:
    build:
      context: .
      dockerfile: services/cache/Dockerfile
    image: haystack-cache:latest
    environment:
      CACHE_DATA_DIR: /app/data/cache_data
      MAX_CACHE_SIZE_BYTES: 50000000
    ports:
      - "8201:8201"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    command:
      [
        "uvicorn",
        "services.cache.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8201",
      ]

  # ----------------------------------------------------
  # 7. RabbitMQ Service (Asynchronous Messaging)
  # ----------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5673:5672" # Standard AMQP port
      - "15673:15672" # Management interface
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - haystack-net
