version: "3.8"

# Define a shared network for service communication
networks:
  haystack-net:
    driver: bridge

# Define volumes for persistent data (FAISS index, SQLite DB, Store data, Cache data)
volumes:
  data-volume:
    driver: local

services:
  # ----------------------------------------------------
  # 1. API Gateway (Entry Point)
  # ----------------------------------------------------
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    image: haystack-api:latest
    ports:
      - "8000:8000" # Expose the API Gateway port
    environment:
      # DIRECTORY access is now through the Discovery Service (DS)
      DISCOVERY_SERVICE_URL: http://discovery:8501
      CACHE_URL: http://cache:8201
      SIMILARITY_URL: http://similarity:8301
      USE_RABBITMQ: "0" # Disabled
      # Store mapping uses internal service names/ports (no localhost)
      STORE_PORTS: "store1=store1:8101,store2=store2:8101,store3=store3:8101"
    networks:
      - haystack-net
    depends_on:
      - discovery
      - directory_replica
      - directory_replica_2
      - store1
      - store2
      - store3
      - cache
      - similarity
    # CMD using the fully qualified path
    command:
      [
        "uvicorn",
        "services.api.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8000",
      ]

  # ----------------------------------------------------
  # 2. Service Discovery (New Central Registry)
  # ----------------------------------------------------
  discovery:
    build:
      context: .
      dockerfile: services/discovery/Dockerfile
    image: haystack-discovery:latest
    environment:
      # Data file for persistence (inside shared volume)
      DISCOVERY_FILE: data/discovery.json
    ports:
      - "8501:8501" # Host port for testing discovery directly
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    command:
      [
        "uvicorn",
        "services.discovery.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8501",
      ]

  # ----------------------------------------------------
  # 3. Directory Services (Primary & Replica)
  # ----------------------------------------------------
  directory_primary:
    build:
      context: .
      dockerfile: services/directory/Dockerfile
    image: haystack-directory:latest
    environment:
      DIRECTORY_MODE: primary
      DISCOVERY_SERVICE_URL: http://discovery:8501
      DB_PATH: data/directory.db
      # Directory knows what stores are available for allocation
      AVAILABLE_STORES: "store1,store2,store3"
      HOSTNAME: directory_primary # Used by the app for registration
    ports:
      - "8001:8001"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    depends_on:
      - discovery # Must wait for discovery service to be ready
    command:
      [
        "uvicorn",
        "services.directory.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8001",
      ]

  directory_replica:
    build:
      context: .
      dockerfile: services/directory/Dockerfile
    image: haystack-directory:latest
    environment:
      DIRECTORY_MODE: replica
      DISCOVERY_SERVICE_URL: http://discovery:8501
      DB_PATH: data/directory.db
      AVAILABLE_STORES: "store1,store2,store3"
      HOSTNAME: directory_replica # Used by the app for registration
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    depends_on:
      - discovery
    command:
      [
        "uvicorn",
        "services.directory.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8001",
      ]

  directory_replica_2:
    build:
      context: .
      dockerfile: services/directory/Dockerfile
    image: haystack-directory:latest
    environment:
      DIRECTORY_MODE: replica
      DISCOVERY_SERVICE_URL: http://discovery:8501
      DB_PATH: data/directory.db
      AVAILABLE_STORES: "store1,store2,store3"
      HOSTNAME: directory_replica_2 # Unique Hostname
    ports:
      - "8003:8001" # Expose on a new host port (8003)
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    depends_on:
      - discovery
    command:
      [
        "uvicorn",
        "services.directory.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8001",
      ]

  # ----------------------------------------------------
  # 4. Store Services (Three Instances for 3-way replication)
  # ----------------------------------------------------
  store1:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store1
      DATA_DIR: /app/data/store1_data
    ports:
      - "8101:8101"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store1_data
    command:
      [
        "uvicorn",
        "services.store.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8101",
      ]

  store2:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store2
      DATA_DIR: /app/data/store2_data
    ports:
      - "8102:8101" # Host 8102 -> Container 8101
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store2_data
    command:
      [
        "uvicorn",
        "services.store.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8101",
      ]

  store3:
    build:
      context: .
      dockerfile: services/store/Dockerfile
    image: haystack-store:latest
    environment:
      STORE_ID: store3
      DATA_DIR: /app/data/store3_data
    ports:
      - "8103:8101" # Host 8103 -> Container 8101
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/store3_data
    command:
      [
        "uvicorn",
        "services.store.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8101",
      ]

  # ----------------------------------------------------
  # 5. Similarity Service (CPU Only)
  # ----------------------------------------------------
  similarity:
    build:
      context: .
      dockerfile: services/similarity/Dockerfile
    image: haystack-similarity:latest
    ports:
      - "8301:8301"
    environment:
      DATA_BASE_DIR: /app/data
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data
    command:
      [
        "uvicorn",
        "services.similarity.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8301",
      ]

  # ----------------------------------------------------
  # 6. Cache Service
  # ----------------------------------------------------
  cache:
    build:
      context: .
      dockerfile: services/cache/Dockerfile
    image: haystack-cache:latest
    environment:
      CACHE_DATA_DIR: /app/data/cache_data
      MAX_CACHE_SIZE_BYTES: 50000000
    ports:
      - "8201:8201"
    networks:
      - haystack-net
    volumes:
      - data-volume:/app/data/cache_data
    command:
      [
        "uvicorn",
        "services.cache.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "8201",
      ]
